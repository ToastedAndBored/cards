<!doctype html>
<html>
    <head>
        {{ template "comp_header.html" . }}
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        />
    </head>
    <body>
        <header>{{ template "comp_nav.html" . }}</header>
        <div class="editor-layout">

            <br />
            <section id="controls">
                <form
                    id="editor-form"
                    action="{{.EditUrl}}"
                    method="post"
                    enctype="multipart/form-data"
                >
                    <label for="input-name">Name</label> <br />
                    <input
                        name="name"
                        id="input-name"
                        type="text"
                        value="{{.Card.Fields.Name}}"
                        required
                    />
                    <br />

                    <label for="input-company">Company</label> <br />
                    <input
                        name="company"
                        id="input-company"
                        type="text"
                        value="{{.Card.Fields.Company}}"
                    />
                    <br />

                    <label for="input-logo">Company Logo</label> <br />
                    <input
                        name="logo"
                        id="input-logo"
                        type="file"
                        accept="image/*"
                    />
                    <br />

                    <label for="input-position">Position</label> <br />
                    <input
                        name="position"
                        id="input-position"
                        type="text"
                        value="{{.Card.Fields.Position}}"
                    />
                    <br />

                    <label for="input-description">Self description</label>
                    <br />
                    <textarea
                        name="description"
                        id="input-description"
                        rows="5"
                    >
        {{.Card.Fields.Description}}</textarea
                    >
                    <br />

                    <hr />
                    <h4>Avatar & Crop</h4>
                    <br />

                    <label for="input-avatar-precrop">Avatar Image</label>
                    <br />
                    <input
                        name="avatar-precrop"
                        id="input-avatar-precrop"
                        type="file"
                        accept="image/*"
                    />
                    <input
                        name="avatar"
                        id="input-avatar"
                        type="file"
                        accept="image/*"
                        hidden
                    />
                    <br />
                    <!-- Preview & Crop -->
                    <div id="preview-container">
                        <img id="image-preview" style="display: none" />
                    </div>
                    <button id="crop-btn" type="button" style="display: none">
                        Crop Image
                    </button>

                    <hr />
                    <h4>Contacts</h4>
                    <br />

                    <label for="input-phone">Phone</label> <br />
                    <input
                        name="phone"
                        id="input-phone"
                        type="tel"
                        value="{{.Card.Fields.Phone}}"
                    />
                    <br />

                    <label for="input-email">Email</label> <br />
                    <input
                        name="email"
                        id="input-email"
                        type="email"
                        value="{{.Card.Fields.Email}}"
                    />
                    <br />

                    <label for="input-telegram">Telegram URL</label> <br />
                    <input
                        name="telegram"
                        id="input-telegram"
                        type="url"
                        value="{{.Card.Fields.Telegram}}"
                    />
                    <br />

                    <label for="input-whatsapp">WhatsApp URL</label> <br />
                    <input
                        name="whatsapp"
                        id="input-whatsapp"
                        type="url"
                        value="{{.Card.Fields.Whatsapp}}"
                    />
                    <br />

                    <label for="input-vk">VK URL</label> <br />
                    <input
                        name="vk"
                        id="input-vk"
                        type="url"
                        value="{{.Card.Fields.VK}}"
                    />
                    <br />

                    <button type="submit">{{.SubmitButton}}</button>
                </form>
            </section>
            <aside id="card-preview">
                <h2 id="card-company"></h2>
                <div class="logo-container" id="logo-container">
                    <img id="card-logo" src="" alt="Company logo" style="display:none;">
                </div>
                <div class="avatar">
                    {{if .Card.AvatarExist}}
                    <img
                        id="card-image-preview"
                        src="/media/avatar/{{.Card.ID}}"
                        alt="Your avatar preview"
                    />
                    {{else}}
                    <img id="card-image-preview" src="" alt="Your avatar preview" />
                    {{end}}
                </div>
                <h3 id="card-name"></h3>
                <h4 id="card-position"></h4>
                <p id="card-text"></p>
                <div class="contact-buttons">
                    <a id="btn-phone" href="#" title="Phone">üìû</a>
                    <a id="btn-email" href="#" title="Email">‚úâÔ∏è</a>
                    <a id="btn-telegram" href="#" title="Telegram">üì®</a>
                    <a id="btn-whatsapp" href="#" title="WhatsApp">üí¨</a>
                    <a id="btn-vk" href="#" title="VK">üñºÔ∏è</a>
                </div>
            </aside>
        </div>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
        ></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
            // Preview elements
            const cardCompany  = document.getElementById('card-company');
            const cardLogoImg  = document.getElementById('card-logo');
            const cardLogoCont = document.getElementById('logo-container');
            const cardAvatar   = document.getElementById('card-image-preview');
            const cardName     = document.getElementById('card-name');
            const cardPosition = document.getElementById('card-position');
            const cardText     = document.getElementById('card-text');
            const btnPhone     = document.getElementById('btn-phone');
            const btnEmail     = document.getElementById('btn-email');
            const btnTelegram  = document.getElementById('btn-telegram');
            const btnWhatsapp  = document.getElementById('btn-whatsapp');
            const btnVk        = document.getElementById('btn-vk');

            // Form inputs
            const inputCompany  = document.getElementById('input-company');
            const logoInput     = document.getElementById('input-logo');
            const inputName     = document.getElementById('input-name');
            const inputPosition = document.getElementById('input-position');
            const inputDesc     = document.getElementById('input-description');
            const inputAvatar   = document.getElementById('input-avatar-precrop');
            const inputPhone    = document.getElementById('input-phone');
            const inputEmail    = document.getElementById('input-email');
            const inputTelegram = document.getElementById('input-telegram');
            const inputWhatsapp = document.getElementById('input-whatsapp');
            const inputVk       = document.getElementById('input-vk');

            function updatePreview() {
                cardCompany.textContent  = inputCompany.value.trim();
                cardName.textContent     = inputName.value.trim();
                cardPosition.textContent = inputPosition.value.trim();
                cardText.textContent     = inputDesc.value.trim();

                // Avatar preview
                if (inputAvatar.files[0]) {
                cardAvatar.src = URL.createObjectURL(inputAvatar.files[0]);
                }

                // Contact buttons
                [
                { inp: inputPhone,  btn: btnPhone,  prefix: 'tel:' },
                { inp: inputEmail,  btn: btnEmail,  prefix: 'mailto:' },
                { inp: inputTelegram, btn: btnTelegram, prefix: '' },
                { inp: inputWhatsapp, btn: btnWhatsapp, prefix: '' },
                { inp: inputVk,      btn: btnVk,      prefix: '' },
                ].forEach(({ inp, btn, prefix }) => {
                const val = inp.value.trim();
                if (val) {
                    btn.href = prefix + val;
                    btn.style.display = 'inline-flex';
                } else {
                    btn.style.display = 'none';
                }
                });
            }


            // Cropper
            const fileInput = document.getElementById("input-avatar-precrop");
            const resultPreview = cardAvatar;
            let cropper;
            fileInput.addEventListener("change", e => {
                const file = e.target.files[0];
                if (!file) return;
                const url = URL.createObjectURL(file);
                const image = document.getElementById("image-preview");
                image.src = url; image.style.display = "block";
                if (cropper) cropper.destroy();
                cropper = new Cropper(image, {
                aspectRatio: 1,
                viewMode: 1,
                autoCrop: true,
                autoCropArea: 0.8,
                cropend() {
                    const canvas = cropper.getCroppedCanvas();
                    resultPreview.src = canvas.toDataURL();
                }
                });
            });

            // Listeners
            [
                inputCompany, inputName, inputPosition, inputDesc,
                inputAvatar, inputPhone, inputEmail,
                inputTelegram, inputWhatsapp, inputVk
            ].forEach(el => {
                el.addEventListener('input', updatePreview);
                el.addEventListener('change', updatePreview);
            });

            logoInput.addEventListener('change', () => {
                const file = logoInput.files[0];
                if (!file) {
                    cardLogoImg.style.display = 'none';
                    cardLogoCont.style.display = 'none';
                    return;
                }
                const reader = new FileReader();
                reader.onload = evt => {
                    const dataUrl = evt.target.result;
                    // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø—Ä–µ–≤—å—é
                    cardLogoImg.src = dataUrl;
                    cardLogoImg.style.display = 'block';
                    cardLogoCont.style.display = "block";

                };
                reader.readAsDataURL(file);
                });

            // init
            updatePreview();
            });
            
        </script>
    </body>
</html>
